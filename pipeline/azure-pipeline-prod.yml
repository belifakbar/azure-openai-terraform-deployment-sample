name: Prod CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  TF_WORKING_DIR: "infra"
  AZURE_RESOURCE_GROUP_PROD: "rg-prod-openai-app"
  AZURE_CONTAINER_REGISTRY_PROD: "acrprodopenai"
  AZURE_AKS_CLUSTER_PROD: "aks-prod-openai"
  AZURE_LOCATION: "East US"

jobs:
  terraform_plan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.x

    - name: Terraform Init
      run: terraform init
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Terraform Validate
      run: terraform validate
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Terraform Plan
      run: terraform plan -out=tfplan
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Upload Terraform Plan Artifact
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan
        path: ${{ env.TF_WORKING_DIR }}/tfplan

  terraform_apply:
    runs-on: ubuntu-latest
    needs: terraform_plan
    environment:
      name: prod
      url: https://prod.example.com # Replace with your prod app URL

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

    - name: Download Terraform Plan Artifact
      uses: actions/download-artifact@v4
      with:
        name: terraform-plan
        path: ${{ env.TF_WORKING_DIR }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.x

    - name: Terraform Apply (Prod)
      run: terraform apply tfplan
      working-directory: ${{ env.TF_WORKING_DIR }}

  build_and_push_docker:
    runs-on: ubuntu-latest
    needs: terraform_apply

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install Python dependencies
      run: pip install -r sample-application/requirements.txt

    - name: Build and push Docker image
      run: |
        az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY_PROD }}
        docker build -t ${{ env.AZURE_CONTAINER_REGISTRY_PROD }}.azurecr.io/sample-app:prod-${{ github.run_number }} ./sample-application
        docker push ${{ env.AZURE_CONTAINER_REGISTRY_PROD }}.azurecr.io/sample-app:prod-${{ github.run_number }}

  deploy_to_aks:
    runs-on: ubuntu-latest
    needs: build_and_push_docker

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

    - name: Get AKS Credentials
      run: az aks get-credentials --resource-group ${{ env.AZURE_RESOURCE_GROUP_PROD }} --name ${{ env.AZURE_AKS_CLUSTER_PROD }} --overwrite-kubeconfig

    - name: Deploy to AKS (Prod)
      run: |
        # Example deployment command to AKS. Replace with your actual deployment logic.
        # This could be helm, kubectl, or a custom script.
        # For example, using kubectl to update a deployment:
        kubectl set image deployment/sample-app sample-app=${{ env.AZURE_CONTAINER_REGISTRY_PROD }}.azurecr.io/sample-app:prod-${{ github.run_number }}
